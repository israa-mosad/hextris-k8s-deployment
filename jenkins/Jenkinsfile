pipeline {
  agent {
    kubernetes {
      label 'hextris-agent'
      defaultContainer 'jnlp'
      yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:debug
    tty: true
    volumeMounts:
    - mountPath: /home/jenkins/agent
      name: workspace-volume
    workingDir: /home/jenkins/agent
  - name: kubectl
    image: bitnami/kubectl:1.30
    tty: true
    volumeMounts:
    - mountPath: /home/jenkins/agent
      name: workspace-volume
    workingDir: /home/jenkins/agent
  volumes:
  - emptyDir: {}
    name: workspace-volume
"""
    }
  }
  stages {
    stage('Checkout') {
      steps { checkout scm }
    }
    stage('Build & Push Docker') {
      steps {
        container('kaniko') {
          sh '/kaniko/executor --dockerfile=Dockerfile --context=dir://. --destination=docker.io/israa2000/hextris:latest --cache=true'
        }
      }
    }
    stage('Deploy to Kubernetes') {
      steps {
        container('kubectl') {
          sh '''
          helm template hextris ./helm-chart > k8s-manifests.yaml
          kubectl apply -f k8s-manifests.yaml
          '''
        }
      }
    }
  }
}
