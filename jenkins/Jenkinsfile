podTemplate(
  label: 'hextris-agent',
  serviceAccount: 'jenkins-sa',
  containers: [
    containerTemplate(
      name: 'kubectl',
      image: 'israa2000/jenkins-agent-kubectl-helm:latest',
      command: 'cat',
      ttyEnabled: true
    )
  ]
) {
  node('hextris-agent') {

    stage('Checkout') {
      checkout scm
    }

    stage('Bootstrap RBAC') {
      container('kubectl') {
        sh '''
          kubectl apply -f k8s/rbac.yaml
        '''
      }
    }

    stage('Deploy with Helm') {
      container('kubectl') {
        sh '''
          helm upgrade --install hextris ./helm-chart \
            --namespace hextris --create-namespace
        '''
      }
    }

  }
}
