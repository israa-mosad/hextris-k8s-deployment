pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: devops-tools
    // IMPORTANT: This image MUST contain 'kubectl', 'helm', AND 'terraform'
    image: israa2000/jenkins-agent-kubectl-helm:latest 
    command:
    - cat
    tty: true
"""
            defaultContainer 'devops-tools' // Use a clear container name
        }
    }
    
    // Set environment variables for the application image that was pre-pushed
    environment {
        // Since you pre-pushed, we'll hardcode the known image and tag
        IMAGE_REPO = "israa2000/hextris" 
        IMAGE_TAG = "latest" 
    }

    stages {
        stage('Deploy with Terraform') {
            steps {
                container('devops-tools') {
                    script {
                        sh '''
                          set -e
                          echo "Starting Terraform deployment..."
                          
                          # 1. Initialize Terraform
                          cd terraform
                          terraform init
                          
                          # 2. Plan and Apply deployment (passing image details)
                          terraform apply -auto-approve \
                            -var="docker_image_repo=${IMAGE_REPO}" \
                            -var="docker_image_tag=${IMAGE_TAG}"
                        '''
                    }
                }
            }
        }
        
        stage('Verification') {
            steps {
                container('devops-tools') {
                    // Wait for the deployment to roll out successfully
                    sh 'kubectl rollout status deployment/hextris -n hextris --timeout=300s'
                    sh 'kubectl get pods -n hextris'
                    sh 'kubectl get ingress hextris -n hextris'
                }
            }
        }
    }
}
